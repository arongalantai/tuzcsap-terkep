<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<title>TÅ±zcsap tÃ©rkÃ©p</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
html,body{height:100%;margin:0;font-family:Arial}
#map{height:100vh;width:100vw}

.panel{
 position:absolute;
 top:10px;
 left:10px;
 z-index:1000;
 background:#fff;
 padding:10px;
 border-radius:6px;
 box-shadow:0 2px 6px rgba(0,0,0,.3);
 font-size:14px;
 width:280px;
 max-height:95vh;
 overflow:auto
}

button,input{
 width:100%;
 margin-top:6px;
 font-size:15px
}

.admin{
 background:#f5f5f5;
 padding:6px;
 margin-top:6px
}

@media (max-width:600px){
 .panel{
  width:90vw;
  left:5vw;
  font-size:16px
 }
}
</style>
</head>

<body>

<div class="panel">
  <input id="addr" placeholder="CÃ­m keresÃ©se">
  <button onclick="searchAddr()">ğŸ” CÃ­m keresÃ©se</button>
  <button onclick="locate()">ğŸ“ SajÃ¡t hely (GPS)</button>
  <button onclick="routeToNearest()">ğŸ§­ Ãštvonal a legkÃ¶zelebbihez</button>

  <hr>
  <button onclick="enableReportMode()">ğŸš¨ HiÃ¡nyzÃ³ tÅ±zcsap jelentÃ©se</button>
  <button onclick="adminLogin()">ğŸ” Admin mÃ³d</button>

  <div id="adminPanel" class="admin" style="display:none"></div>
  <div id="info"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* ===== KONFIG ===== */
const ADMIN_PIN = "1234";
const MIN_ZOOM = 13;          // ğŸ”¥ MOBILFIX
const DUPLICATE_DISTANCE = 15;

/* ===== MAP ===== */
const map = L.map("map", { tap:true }).setView([47.1625,19.5033],7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
const cluster = L.markerClusterGroup();
map.addLayer(cluster);

/* ===== IKON ===== */
const hydrantIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/2972/2972185.png",
  iconSize: [28,28],
  iconAnchor: [14,28],
  popupAnchor: [0,-28]
});

/* ===== ÃLLAPOT ===== */
let hydrants=[], lastBBox=null;
let userMarker=null, routeLine=null;
let reportMode=false;
let reports = JSON.parse(localStorage.getItem("hydrantReports")||"[]");
let reportMarkers=[];

/* ===== SEGÃ‰D ===== */
function hav(lat1,lon1,lat2,lon2){
 const R=6371000,t=x=>x*Math.PI/180;
 return 2*R*Math.asin(Math.sqrt(
  Math.sin(t(lat2-lat1)/2)**2+
  Math.cos(t(lat1))*Math.cos(t(lat2))*Math.sin(t(lon2-lon1)/2)**2
 ));
}
function isDuplicate(lat,lon){
 return hydrants.some(h=>hav(lat,lon,h.lat,h.lon)<DUPLICATE_DISTANCE);
}

/* ===== TÅ°ZCSAPOK ===== */
async function loadHydrants(){
 if(map.getZoom()<MIN_ZOOM){
  cluster.clearLayers();
  hydrants=[];
  return;
 }

 const b=map.getBounds();
 const bb=[b.getSouth(),b.getWest(),b.getNorth(),b.getEast()];
 if(JSON.stringify(bb)===JSON.stringify(lastBBox)) return;
 lastBBox=bb;

 cluster.clearLayers();
 hydrants=[];

 const q=`[out:json][timeout:25];
 (
  node["emergency"="fire_hydrant"](${bb.join(",")});
  node["emergency"="hydrant"](${bb.join(",")});
  node["fire_hydrant"="yes"](${bb.join(",")});
 );
 out body;`;

 const r=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:q});
 const d=await r.json();

 d.elements.forEach(h=>{
  if(!h.lat||!h.lon||isDuplicate(h.lat,h.lon)) return;

  const m=L.marker([h.lat,h.lon],{icon:hydrantIcon})
    .bindPopup("ğŸš’ TÅ±zcsap");

  hydrants.push({lat:h.lat,lon:h.lon,marker:m});
  cluster.addLayer(m);
 });
}

map.on("moveend",loadHydrants);
map.on("zoomend",loadHydrants);

/* ===== FELHASZNÃLÃ“ ===== */
function setUser(lat,lon){
 if(userMarker) map.removeLayer(userMarker);
 userMarker=L.marker([lat,lon]).addTo(map)
  .bindPopup("ğŸ“ SajÃ¡t hely")
  .openPopup();
 map.setView([lat,lon],16);
}

/* GPS â€“ tÃ¶bb mÃ©rÃ©s */
function locate(){
 let best=null;
 const watchId=navigator.geolocation.watchPosition(
  pos=>{
   const acc=pos.coords.accuracy;
   if(!best||acc<best.acc){
    best={lat:pos.coords.latitude,lon:pos.coords.longitude,acc};
    setUser(best.lat,best.lon);
    info.innerText=`GPS pontossÃ¡g: Â±${Math.round(acc)} m`;
   }
   if(acc<20) navigator.geolocation.clearWatch(watchId);
  },
  ()=>alert("HelymeghatÃ¡rozÃ¡s sikertelen"),
  {enableHighAccuracy:true,timeout:15000,maximumAge:0}
 );
}

/* ===== MAP TAP / CLICK ===== */
map.on("tap",handleMapTap);
map.on("click",handleMapTap);

function handleMapTap(e){
 if(reportMode){
  const note=prompt("MegjegyzÃ©s (opcionÃ¡lis):")||"";
  const r={lat:e.latlng.lat,lon:e.latlng.lng,note,time:new Date().toISOString()};
  reports.push(r);
  localStorage.setItem("hydrantReports",JSON.stringify(reports));

  L.marker(e.latlng,{
    icon:L.divIcon({html:"âŒ",className:"",iconSize:[20,20]})
  }).addTo(map)
    .bindPopup("ğŸš¨ HiÃ¡nyzÃ³ tÅ±zcsap jelentve")
    .openPopup();

  reportMode=false;
  return;
 }
 setUser(e.latlng.lat,e.latlng.lng);
}

/* ===== CÃM ===== */
async function searchAddr(){
 const r=await fetch(
  `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr.value)}`
 );
 const d=await r.json();
 if(d[0]) setUser(+d[0].lat,+d[0].lon);
}

/* ===== ÃšTVONAL ===== */
function nearestHydrant(){
 if(!userMarker||hydrants.length===0) return null;
 const u=userMarker.getLatLng(); let best=null;
 hydrants.forEach(h=>{
  const d=hav(u.lat,u.lng,h.lat,h.lon);
  if(!best||d<best.d) best={...h,d};
 });
 info.innerText=`LegkÃ¶zelebbi tÅ±zcsap: ${Math.round(best.d)} m`;
 best.marker.openPopup();
 return best;
}

async function routeToNearest(){
 const h=nearestHydrant();
 if(!h) return;
 if(routeLine) map.removeLayer(routeLine);
 const u=userMarker.getLatLng();
 const r=await fetch(
  `https://router.project-osrm.org/route/v1/foot/${u.lng},${u.lat};${h.lon},${h.lat}?overview=full&geometries=geojson`
 );
 const d=await r.json();
 routeLine=L.geoJSON(d.routes[0].geometry,{color:"blue"}).addTo(map);
}

/* ===== JELENTÃ‰S + ADMIN ===== */
function enableReportMode(){
 reportMode=true;
 alert("JelentÃ©s mÃ³d aktÃ­v.\nÃ‰rintsd meg a tÃ©rkÃ©pet a tÅ±zcsap helyÃ©n.");
}

function adminLogin(){
 const pin=prompt("Admin PIN:");
 if(pin===ADMIN_PIN){
  showAdminPanel();
  drawReports();
 } else alert("HibÃ¡s PIN");
}

function showAdminPanel(){
 adminPanel.style.display="block";
 adminPanel.innerHTML=`
  <b>Admin mÃ³d</b><br>
  JelentÃ©sek: ${reports.length}<br>
  <button onclick="exportReports()">ğŸ“¤ Export</button>
  <button onclick="clearReports()">ğŸ—‘ï¸ TÃ¶rlÃ©s</button>
 `;
}

function drawReports(){
 reportMarkers.forEach(m=>map.removeLayer(m));
 reportMarkers=[];
 reports.forEach(r=>{
  const m=L.marker([r.lat,r.lon],{
    icon:L.divIcon({html:"âŒ",className:"",iconSize:[20,20]})
  }).addTo(map)
   .bindPopup(`ğŸš¨ HiÃ¡nyzÃ³ tÅ±zcsap<br>${r.note}<br><small>${r.time}</small>`);
  reportMarkers.push(m);
 });
}

function exportReports(){
 if(!reports.length){alert("Nincs jelentÃ©s");return;}
 const txt=reports.map(r=>`${r.lat},${r.lon} | ${r.note} | ${r.time}`).join("\n");
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([txt],{type:"text/plain"}));
 a.download="hianyzo_tuzcsap_jelentesek.txt";
 a.click();
}

function clearReports(){
 if(confirm("Biztos tÃ¶rlÃ¶d az Ã¶sszes jelentÃ©st?")){
  reports=[];
  localStorage.removeItem("hydrantReports");
  reportMarkers.forEach(m=>map.removeLayer(m));
  reportMarkers=[];
  showAdminPanel();
 }
}
</script>

</body>
</html>
