<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<title>TÅ±zcsap tÃ©rkÃ©p</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#d32f2f">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
body{margin:0;font-family:Arial}
#map{height:100vh}
.panel{
  position:absolute;top:10px;left:10px;z-index:1000;
  background:#fff;padding:10px;border-radius:6px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);font-size:14px
}
input,button{margin-top:4px;width:100%}
</style>
</head>
<body>

<div class="panel">
  <input id="addr" placeholder="CÃ­m keresÃ©se">
  <button onclick="searchAddr()">ğŸ” KeresÃ©s</button>
  <button onclick="locate()">ğŸ“ SajÃ¡t hely</button>
  <button onclick="route()">ğŸ§­ Ãštvonal a legkÃ¶zelebbihez</button>
  <div id="info"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const map=L.map("map").setView([47.1625,19.5033],7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

const cluster=L.markerClusterGroup();
map.addLayer(cluster);

let hydrants=[],userMarker=null,routeLine=null,lastBBox=null;
const MIN_ZOOM=15;

function hav(a,b,c,d){
 const R=6371000,t=x=>x*Math.PI/180;
 return 2*R*Math.asin(Math.sqrt(
  Math.sin(t(c-a)/2)**2+Math.cos(t(a))*Math.cos(t(c))*Math.sin(t(d-b)/2)**2
 ));
}

async function loadHydrants(){
 if(map.getZoom()<MIN_ZOOM){cluster.clearLayers();hydrants=[];return;}
 const b=map.getBounds(),bb=[b.getSouth(),b.getWest(),b.getNorth(),b.getEast()];
 if(JSON.stringify(bb)===JSON.stringify(lastBBox))return;
 lastBBox=bb;cluster.clearLayers();hydrants=[];
 const q=`[out:json][timeout:25];node["emergency"="fire_hydrant"](${bb.join(",")});out body;`;
 const r=await fetch("fetch("https://overpass-api.de/api/interpreter", {
 ",{method:"POST",body:q});
 const d=await r.json();
 d.elements.forEach(e=>{
  const m=L.circleMarker([e.lat,e.lon],{radius:5,color:"red",fillOpacity:.8});
  cluster.addLayer(m);hydrants.push({lat:e.lat,lon:e.lon,marker:m});
 });
}
map.on("moveend",loadHydrants);map.on("zoomend",loadHydrants);

function setUser(lat,lon){
 if(userMarker)map.removeLayer(userMarker);
 userMarker=L.marker([lat,lon]).addTo(map).bindPopup("ğŸ“ Te").openPopup();
 map.setView([lat,lon],16);
}

function locate(){
 navigator.geolocation.getCurrentPosition(p=>{
  setUser(p.coords.latitude,p.coords.longitude);
 });
}

async function searchAddr(){
 const q=document.getElementById("addr").value;
 const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
 const d=await r.json(); if(!d[0])return;
 setUser(+d[0].lat,+d[0].lon);
}

function nearest(){
 if(!userMarker||hydrants.length===0)return null;
 const u=userMarker.getLatLng();let best=null;
 hydrants.forEach(h=>{
  const d=hav(u.lat,u.lng,h.lat,h.lon);
  if(!best||d<best.d)best={...h,d};
 });
 document.getElementById("info").innerText=`LegkÃ¶zelebbi: ${Math.round(best.d)} m`;
 best.marker.openPopup();return best;
}

async function route(){
 const n=nearest(); if(!n)return;
 if(routeLine)map.removeLayer(routeLine);
 const u=userMarker.getLatLng();
 const url=`https://router.project-osrm.org/route/v1/foot/${u.lng},${u.lat};${n.lon},${n.lat}?overview=full&geometries=geojson`;
 const r=await fetch(url);const d=await r.json();
 routeLine=L.geoJSON(d.routes[0].geometry,{color:"blue"}).addTo(map);
}

if("serviceWorker"in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
