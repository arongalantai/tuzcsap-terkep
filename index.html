<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<title>T≈±zcsap t√©rk√©p</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: Arial, sans-serif;
}

#map {
  height: 100vh;
  width: 100vw;
}

.panel {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background: white;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
  font-size: 14px;
  width: 220px;
}

input, button {
  width: 100%;
  margin-top: 5px;
}
</style>
</head>

<body>

<div class="panel">
  <input id="addr" placeholder="C√≠m keres√©se">
  <button onclick="searchAddr()">üîç Keres√©s</button>
  <button onclick="locate()">üìç Saj√°t hely</button>
  <button onclick="routeToNearest()">üß≠ √ötvonal a legk√∂zelebbihez</button>
  <div id="info"></div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* ====== T√âRK√âP ====== */
const map = L.map("map").setView([47.1625, 19.5033], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "¬© OpenStreetMap"
}).addTo(map);

const cluster = L.markerClusterGroup();
map.addLayer(cluster);

/* ====== √ÅLLAPOT ====== */
let hydrants = [];
let userMarker = null;
let routeLine = null;
let lastBBox = null;
const MIN_ZOOM = 15;

/* ====== T√ÅVOLS√ÅG ====== */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  return 2 * R * Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)**2
  ));
}

/* ====== OVERPASS LEK√âR√âS ====== */
async function loadHydrants() {
  if (map.getZoom() < MIN_ZOOM) {
    cluster.clearLayers();
    hydrants = [];
    return;
  }

  const b = map.getBounds();
  const bbox = [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()];
  if (JSON.stringify(bbox) === JSON.stringify(lastBBox)) return;
  lastBBox = bbox;

  cluster.clearLayers();
  hydrants = [];

  const query = `
[out:json][timeout:25];
node["emergency"="fire_hydrant"](${bbox.join(",")});
out body;
`;

  try {
    const r = await fetch("https://overpass-api.de/api/interpreter", {
      method: "POST",
      body: query
    });
    const d = await r.json();

    d.elements.forEach(h => {
      const m = L.circleMarker([h.lat, h.lon], {
        radius: 5,
        color: "red",
        fillOpacity: 0.8
      }).bindPopup("üöí T≈±zcsap");

      cluster.addLayer(m);
      hydrants.push({ lat: h.lat, lon: h.lon, marker: m });
    });
  } catch (e) {
    console.error("Overpass hiba:", e);
  }
}

map.on("moveend", loadHydrants);
map.on("zoomend", loadHydrants);

/* ====== FELHASZN√ÅL√ì ====== */
function setUser(lat, lon) {
  if (userMarker) map.removeLayer(userMarker);
  userMarker = L.marker([lat, lon]).addTo(map).bindPopup("üìç Te itt vagy").openPopup();
  map.setView([lat, lon], 16);
}

function locate() {
  navigator.geolocation.getCurrentPosition(p => {
    setUser(p.coords.latitude, p.coords.longitude);
  });
}

/* ====== C√çM KERES√âS ====== */
async function searchAddr() {
  const q = document.getElementById("addr").value;
  const r = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`
  );
  const d = await r.json();
  if (d[0]) setUser(+d[0].lat, +d[0].lon);
}

/* ====== LEGK√ñZELEBBI ====== */
function nearestHydrant() {
  if (!userMarker || hydrants.length === 0) return null;
  const u = userMarker.getLatLng();
  let best = null;

  hydrants.forEach(h => {
    const d = haversine(u.lat, u.lng, h.lat, h.lon);
    if (!best || d < best.d) best = { ...h, d };
  });

  document.getElementById("info").innerText =
    `Legk√∂zelebbi t≈±zcsap: ${Math.round(best.d)} m`;

  best.marker.openPopup();
  return best;
}

/* ====== √öTVONAL ====== */
async function routeToNearest() {
  const h = nearestHydrant();
  if (!h) return;

  if (routeLine) map.removeLayer(routeLine);

  const u = userMarker.getLatLng();
  const url = `https://router.project-osrm.org/route/v1/foot/${u.lng},${u.lat};${h.lon},${h.lat}?overview=full&geometries=geojson`;
  const r = await fetch(url);
  const d = await r.json();

  routeLine = L.geoJSON(d.routes[0].geometry, {
    color: "blue",
    weight: 4
  }).addTo(map);
}

/* ====== SERVICE WORKER ====== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
